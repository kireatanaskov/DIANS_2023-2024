<div xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml" class="main-div">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/nodesCSS.css">
  
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <div class="sidebar">
    <nav>
      <ul>
        <li>
          <a href="/node/all">
            <i class="fas fa-home"></i>
            <p>Home</p>
          </a>
        </li>
        <li sec:authorize="isAnonymous()">
          <a href="/login">
            <i class="fas fa-sign-in-alt"></i>
            <p>Log In</p>
          </a>
        </li>
        <li sec:authorize="isAuthenticated()">
          <a href="/logout">
            <i class="fas fa-sign-out-alt"></i>
            <p>Log Out</p>
          </a>
        </li>
        <li class="search-box">
          <i class="fas fa-search"></i>
          <form method="GET" action="/node/filteredByName" style="display: flex">
            <input type="search" name="search" placeholder="Search..">
          </form>
        </li>
        <li>
          <a href="#">
            <i class="far fa-user-circle"></i>
            <p sec:authorize="isAuthenticated()">
              Hello, <span sec:authentication="name"></span>!
            </p>
            <p sec:authorize="!isAuthenticated()">
              Welcome, Guest!
            </p>
          </a>
        </li>
      </ul>
    </nav>
  </div>

  <div class="map-container">
    <div class="container-fluid inner-div">
      <div class="row" style="margin: 0">
        <div class="col-4" style="padding: 0">
          <div id="additional-info"></div>
          <div class="row">
            <div class="col" id="starter">
              <h4 id="additional_info">Additional Information</h4>
              <hr />
              <p id="info-content">
                Please select a location to display additional information.
              </p>
            </div>
          </div>

          <hr>
          <div id="controls"></div>
          <hr>
          <div class="row content-align d-flex align-items-center justify-content-center flex-wrap" id="category">
            <div class="col-md-8">
              <div class="text-center">
                <div class="mb-2">
                  <label>Choose a category to filter the nodes:</label>
                </div>
                <div class="mb-2">
                  <button class="btn btn-sm btn-secondary button-style" onclick="resetMap()">all</button>
                </div>

                <form method="GET" action="/node/filteredByCategory" class="d-flex flex-wrap">
                  <th:block th:each="category : ${categories}">
                    <div class="mb-2">
                      <button class="btn btn-sm btn-secondary button-style" name="category" type="submit" th:text="${category}" th:value="${category}"></button>
                    </div>
                  </th:block>
                </form>
              </div>
            </div>
          </div>
          <br>
          <hr>
          <div class="col-sm-3 col-md-7"
               th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}">
            <div id="addNewNode">
              <a
                      href="/node/add-form"
                      class="btn btn-block btn-dark add-product-btn">
                Add new node
              </a>
            </div>
          </div>
        </div>

        <div class="col-8">
          <div class="map">
            <div id="map"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
      var searchForm = document.getElementById("searchForm");

      searchForm.addEventListener("submit", function (event) {
        event.preventDefault();
        performSearch();
      });

      function performSearch() {
        var searchTerm = searchForm.querySelector('input[name="search"]').value;
        window.location.href = "/node/filteredByName?search=" + encodeURIComponent(searchTerm);
      }

      searchForm.querySelector('input[name="search"]').addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          performSearch();
        }
      });
    });

    let nodes = [(${nodes})];
    let map = L.map("map")
            .setView([41.6086, 21.7453], 9); // Skopje
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: ''
    }).addTo(map);

    let markers = [];

    nodes.forEach(function (node) {
      let marker = L.marker([node.latitude, node.longitude])

      marker.on('click', function (e) {
        displayInfo(node);
        changeColorAndFocus(marker, markers);
      });

      markers.push(marker);
    });

    let markerGroup = L.featureGroup(markers).addTo(map);

    map.fitBounds(markerGroup.getBounds());

    function editNode(nodeId) {
      window.location.href = '/node/edit-form/' + nodeId;
    }

    // Getting location
    function getLocation(nodeLatitude, nodeLongitude) {
      // Get the location from the user
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          userLatitude = position.coords.latitude;
          userLongitude = position.coords.longitude;

          console.log(userLatitude, userLongitude); // For kind of debugging purposes

          sendLocationToServer(userLatitude, userLongitude, nodeLatitude, nodeLongitude);
        }, function () {
          alert("Geolocation access is blocked. Please update your browser settings to allow access.")
        });
      } else {
        alert("Geolocation is not supported by this browser.")
      }
    }

    let userLatitude;
    let userLongitude;
    let isAdmin = [(${isAdmin})]
    let isLoggedIn = [(${isLogin})]

    function sendLocationToServer(userLatitude, userLongitude, nodeLatitude, nodeLongitude) {
      console.log("Before fetch");
      fetch('/map/findRoute', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded',},
        body: `startLat=${userLatitude}&startLon=${userLongitude}&endLat=${nodeLatitude}&endLon=${nodeLongitude}`,
      }).then(response => {
        console.log("Received response with status: " + response.status); // For kind of debugging purposes

        if (response.status === 200) {
          console.log("Location sent successfully!");
          window.location.href = '/map';
        } else {
          alert("Error getting location");
        }
      }).catch(error => {
        console.error("Error sending location:", error);
      });
    }

    function rateNode(ratingValue, nodeId) {
      console.log("User rated:", ratingValue);
      window.location.href = '/node/updateRating/' + nodeId + '?userRating=' + ratingValue;
    }

    function createButton(text, onClick, cssClass) {
      return $("<button>").text(text).on("click", onClick).addClass("button-style");
    }

    const displayInfo = (node) => {
      $("#additional-info").empty();  // Clear previous node data
      $("#starter").remove();
      $("#category").remove();
      $("#addNewNode").remove();
      let mainDiv = $("#additional-info")
      let controls = $("#controls");
      controls.empty();

      let res = $("<div>").addClass("container");
      let title = $("<h2>").text(`${node.name}`).addClass("title");
      let paragraph = $("<div>")
      let locations = $("<p>").append(`ðŸ“ ${node.latitude}, ${node.longitude}`);
      let resetMapButton = createButton("Reset Map", resetMap, "btn btn-sm btn-secondary");
      let navigateButton = createButton("Navigate", () => getLocation(node.latitude, node.longitude), "btn btn-sm btn-primary");
      let ratingIntroText = $("<p>").text("Current rating:")
              .css({ paddingTop: "10px", marginBottom: "0px" });

      let rating = $("<p>").text(node.rating.toFixed(2));
      let starContainer = $("<div>");

      if (node.wikipediaData) {
        paragraph.append(`<hr>${node.wikipediaData}`).addClass("paragraph").addClass("text-justify");
      }

      for (let i = 1; i <= 5; i++) {
        let star = document.createElement("button");
        star.innerHTML = "&#9733;";
        star.classList.add("star");

        if (isLoggedIn === true) {
          star.setAttribute("onclick", `rateNode(${i}, ${node.id})`);
        } else {
          star.style.pointerEvents = "none";
          star.classList.add("disabled");
        }
        starContainer.append(star);
      }

      res.append(title,paragraph, locations);
      controls.append(resetMapButton, navigateButton, ratingIntroText, rating, starContainer);

      if (!isLoggedIn) {
        const loginMessage = $("<p>").text("You must be logged in to leave a rating.").addClass("starText");
        controls.append(loginMessage);
      }

      if (isAdmin) {
        //const editButton = $("<button>").text("Edit").on("click", () => editNode(node.id));
        const editButton = createButton("Edit", () => editNode(node.id), "btn btn-sm btn-info");
        res.append(editButton);
      }

      mainDiv.append(res);
    }

    const changeColorAndFocus = (marker, markers) => {
      markers.forEach((m) => {
        m.setIcon(new L.Icon.Default());
      });

      marker.setIcon(new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        tooltipAnchor: [16, -28],
        shadowSize: [41, 41]
      }))

      map.setView(marker.getLatLng(), 16);
    }

    const resetMap = () => {
      map.setView([41.6086, 21.7453], 9);

      markers.forEach((marker) => {
        marker.setIcon(new L.Icon.Default());
      });

      $("#additional-info").empty();
      $("#controls").empty();

      window.location.href = '/node/all';
    }
  </script>
</div>
